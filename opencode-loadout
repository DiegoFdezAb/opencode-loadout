#!/bin/bash

# OpenCode Loadout - Configuration Manager for OpenCode
# Switch between different OpenCode setups easily

set -euo pipefail

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Default paths
CONFIG_FILE="${OPENCODE_LOADOUT_CONFIG:-$HOME/.config/opencode-loadout/config.json}"
PRESETS_DIR="${OPENCODE_LOADOUT_DIR:-$HOME/.config/opencode-loadout/presets}"
PROFILES_DIR="${OPENCODE_PROFILES_DIR:-$HOME/.config/opencode-loadout/profiles}"
BACKUPS_DIR="${OPENCODE_BACKUPS_DIR:-$HOME/.config/opencode-loadout/backups}"
OPENCODE_CONFIG="${OPENCODE_CONFIG_PATH:-$HOME/.config/opencode/opencode.json}"
STATE_FILE="${OPENCODE_LOADOUT_STATE:-$HOME/.config/opencode-loadout/.state}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
  echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
  echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_error() {
  echo -e "${RED}[ERROR]${NC} $1" >&2
}

log_warn() {
  echo -e "${YELLOW}[WARN]${NC} $1"
}

# Check if command exists
command_exists() {
  command -v "$1" &>/dev/null
}

# Ensure required directories exist
ensure_dirs() {
  mkdir -p "$PRESETS_DIR" "$PROFILES_DIR" "$BACKUPS_DIR"
  mkdir -p "$(dirname "$CONFIG_FILE")"
  mkdir -p "$(dirname "$STATE_FILE")"
}

# Initialize state file
init_state() {
  if [[ ! -f "$STATE_FILE" ]]; then
    echo '{"current_preset": "none"}' > "$STATE_FILE"
  fi
}

# Get current preset from state
get_state_preset() {
  init_state
  jq -r '.current_preset' "$STATE_FILE" 2>/dev/null || echo "none"
}

# Set current preset in state
set_state_preset() {
  local preset_name="$1"
  init_state
  jq --arg preset "$preset_name" '.current_preset = $preset' "$STATE_FILE" > "${STATE_FILE}.tmp"
  mv "${STATE_FILE}.tmp" "$STATE_FILE"
}

# Check if OpenCode is installed
check_opencode() {
  if ! command_exists opencode; then
    log_error "OpenCode is not installed"
    log_info "Install it from: https://opencode.ai"
    exit 1
  fi
}

# Check if a plugin is installed
is_plugin_installed() {
  local plugin_full="$1"
  local plugin_name="$plugin_full"
  
  # Strip version tag if present
  if [[ "$plugin_full" == *@* ]]; then
    if [[ "$plugin_full" == @* ]]; then
      # Scoped package: check for second @
      local rest="${plugin_full:1}"
      if [[ "$rest" == *@* ]]; then
        plugin_name="@${rest%@*}"
      fi
    else
      # Regular package: strip after first @
      plugin_name="${plugin_full%@*}"
    fi
  fi
  
  # Check node_modules
  local opencode_dir="${OPENCODE_CONFIG_PATH:-$HOME/.config/opencode}"
  if [[ -d "$opencode_dir/node_modules/$plugin_name" ]]; then
    return 0
  fi
  
  # Check if available via bunx
  if command -v bunx &>/dev/null; then
    if bunx "$plugin_name" --version &>/dev/null 2>&1; then
      return 0
    fi
  fi
  
  return 1
}

# Get installation command for a plugin
get_plugin_install_cmd() {
  local plugin_name="$1"

  case "$plugin_name" in
    "oh-my-opencode")
      echo "bunx oh-my-opencode install"
      ;;
    "opencode-orchestrator")
      echo "bun add opencode-orchestrator"
      ;;
    *)
      echo "npm install $plugin_name"
      ;;
  esac
}

# Backup current config
backup_config_if_changed() {
  local timestamp
  timestamp=$(date +%Y%m%d_%H%M%S)
  local backup_file="$BACKUPS_DIR/backup-$timestamp.json"

  if [[ -f "$OPENCODE_CONFIG" ]]; then
    cp "$OPENCODE_CONFIG" "$backup_file"
    log_info "Backup saved to: $backup_file"
  fi
}

# List available presets
list_presets() {
  log_info "Available presets:"

  if [[ ! -d "$PRESETS_DIR" ]]; then
    log_warn "No presets directory found"
    return
  fi

  local first=true
  for preset in "$PRESETS_DIR"/*.json; do
    if [[ -f "$preset" ]]; then
      if $first; then
        echo ""
        first=false
      fi

      local name
      name=$(basename "$preset" .json)
      local desc
      desc=$(jq -r '.description // "No description"' "$preset" 2>/dev/null || echo "No description")

      printf "  ${GREEN}%-20s${NC} %s\n" "$name" "$desc"
    fi
  done
}

# Get current preset
get_current_preset() {
  local state_preset
  state_preset=$(get_state_preset)
  
  # Validate that the state preset matches the actual config
  if [[ "$state_preset" != "none" ]]; then
    local preset_file="$PRESETS_DIR/${state_preset}.json"
    if [[ -f "$preset_file" ]]; then
      # Get plugins from preset file
      local preset_plugins
      preset_plugins=$(jq -c '.plugins // []' "$preset_file")
      
      # Get plugins from actual config
      local actual_plugins="[]"
      if [[ -f "$OPENCODE_CONFIG" ]]; then
        actual_plugins=$(jq -c '.plugin // []' "$OPENCODE_CONFIG")
      fi
      
      # Compare
      if [[ "$preset_plugins" != "$actual_plugins" ]]; then
        # Config doesn't match - reset to none
        log_warn "State preset ($state_preset) doesn't match actual config - resetting to none"
        set_state_preset "none"
        echo "none"
        return
      fi
    fi
  fi
  
  echo "$state_preset"
}

# Show current preset
current() {
  check_opencode
  local current
  current=$(get_current_preset)
  log_success "Current preset: $current"

  if [[ -f "$OPENCODE_CONFIG" ]]; then
    log_info "Active plugins:"
    jq -r '.plugin // []' "$OPENCODE_CONFIG" 2>/dev/null | while read -r plugin; do
      [[ -n "$plugin" ]] && echo "  - $plugin"
    done
  fi
}

# Switch to a preset
switch() {
  local preset_name="$1"

  check_opencode
  ensure_dirs

  local preset_file="$PRESETS_DIR/${preset_name}.json"
  local current_preset
  current_preset=$(get_state_preset)

  if [[ "$current_preset" == "none" ]]; then
    log_warn "Current preset not saved"
    
    # Confirmation y/n (stocké dans $REPLY)
    read -p "Do you want to save this as a new preset? (y/n) " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # Demander le nom et stocker dans la variable preset_name
        read -p "Enter preset name: " preset_name
        
        # Maintenant $preset_name contient le nom entré par l'utilisateur
        if [[ -n "$preset_name" ]]; then
            save "$preset_name"
            log_success "Preset saved: $preset_name"
        else
            log_error "Preset name cannot be empty"
        fi
    else
        log_info "Skipping save"
    fi
  fi

  if [[ ! -f "$preset_file" ]]; then
    
    # Already at a preset - just error
    log_error "Preset not found: $preset_name"
    log_info "Run 'opencode-loadout list' or 'ocl list' to see available presets"
    exit 1
  fi



  # Check if preset exists
  local preset_file="$PRESETS_DIR/${preset_name}.json"

  if [[ ! -f "$preset_file" ]]; then
    log_error "Preset not found: $preset_name"
    log_info "Run 'opencode-loadout list' or 'ocl list' to see available presets"
    log_info "Use 'opencode-loadout save <name>' or 'ocl save <name>' to create a new preset"
    exit 1
  fi

  log_info "Switching to preset: $preset_name"

  # Backup current config
  backup_config_if_changed

  # Check if required plugins are installed
  local missing_plugins=()
  while IFS= read -r plugin; do
    if [[ -n "$plugin" ]] && ! is_plugin_installed "$plugin"; then
      missing_plugins+=("$plugin")
    fi
  done < <(jq -r '.plugins[] // empty' "$preset_file")

  if [[ ${#missing_plugins[@]} -gt 0 ]]; then
    log_warn "Plugin(s) non installé(s) ou version différente :"
    for plugin in "${missing_plugins[@]}"; do
      local install_cmd
      install_cmd=$(get_plugin_install_cmd "$plugin")
      echo "  - $plugin"
      log_info "  Installation recommandée : $install_cmd"
    done
    
    read -p "Souhaitez-vous continuer le switch quand même ? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      log_info "Switch annulé"
      exit 1
    fi
  fi

  # Read preset config
  local plugins
  plugins=$(jq -r '.plugins // []' "$preset_file")

  # Update OpenCode config
  if [[ -f "$OPENCODE_CONFIG" ]]; then
    # Update plugins array
    if [[ "$plugins" == "[]" ]] || [[ -z "$plugins" ]]; then
      jq 'del(.plugin)' "$OPENCODE_CONFIG" > "${OPENCODE_CONFIG}.tmp"
      mv "${OPENCODE_CONFIG}.tmp" "$OPENCODE_CONFIG"
    else
      jq --argjson plugins "$plugins" '.plugin = $plugins' "$OPENCODE_CONFIG" > "${OPENCODE_CONFIG}.tmp"
      mv "${OPENCODE_CONFIG}.tmp" "$OPENCODE_CONFIG"
    fi
  else
    # Create new config
    echo '{}' > "$OPENCODE_CONFIG"
    jq --argjson plugins "$plugins" '.plugin = $plugins' "$OPENCODE_CONFIG" > "${OPENCODE_CONFIG}.tmp"
    mv "${OPENCODE_CONFIG}.tmp" "$OPENCODE_CONFIG"
  fi

  # Save current preset to state
  set_state_preset "$preset_name"

  log_success "Preset applied: $preset_name"
  log_info "Restart OpenCode for changes to take effect"
}

# Initialize project with preset
init() {
  local preset_name="${1:-omo}"

  check_opencode
  ensure_dirs

  if [[ ! -f ".opencode" ]]; then
    mkdir -p .opencode
  fi

  # Copy project-specific config
  local profile_file="$PROFILES_DIR/${preset_name}.json"
  if [[ -f "$profile_file" ]]; then
    cp "$profile_file" .opencode/oh-my-opencode.json
    log_success "Initialized project with preset: $preset_name"
  else
    log_warn "Profile not found: $preset_name"
    log_info "Creating empty config"
    echo '{}' > .opencode/oh-my-opencode.json
  fi
}

# Use project profile
profile() {
  local action="$1"
  shift

  case "$action" in
    list)
      log_info "Available profiles:"
      if [[ -d "$PROFILES_DIR" ]]; then
        for profile in "$PROFILES_DIR"/*.json; do
          if [[ -f "$profile" ]]; then
            local name
            name=$(basename "$profile" .json)
            local desc
            desc=$(jq -r '.description // "No description"' "$profile" 2>/dev/null || echo "No description")
            printf "  ${GREEN}%-20s${NC} %s\n" "$name" "$desc"
          fi
        done
      fi
      ;;
    use)
      local profile_name="$1"
      local profile_file="$PROFILES_DIR/${profile_name}.json"

      if [[ ! -f "$profile_file" ]]; then
        log_error "Profile not found: $profile_name"
        exit 1
      fi

      mkdir -p .opencode
      cp "$profile_file" .opencode/oh-my-opencode.json
      log_success "Using profile: $profile_name"
      ;;
    *)
      log_error "Unknown profile action: $action"
      log_info "Available actions: list, use"
      exit 1
      ;;
  esac
}

# Show preset info
info() {
  local preset_name="$1"
  local preset_file="$PRESETS_DIR/${preset_name}.json"

  if [[ ! -f "$preset_file" ]]; then
    log_error "Preset not found: $preset_name"
    exit 1
  fi

  log_info "Preset: $preset_name"
  jq -r ' "\(.description // "No description")\n\nPlugins: \(.plugins | join(", "))\nRequires: \(.requires | keys | join(", "))"' "$preset_file"
}

# Save current configuration as a preset
save() {
  local preset_name="$1"

  check_opencode
  ensure_dirs

  if [[ -z "$preset_name" ]]; then
    log_error "Preset name is required"
    log_info "Usage: opencode-loadout save <preset-name> or ocl save <preset-name>"
    exit 1
  fi

  local preset_file="$PRESETS_DIR/${preset_name}.json"

  if [[ -f "$preset_file" ]]; then
    read -p "Preset '$preset_name' already exists. Overwrite? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      log_info "Save cancelled"
      exit 0
    fi
  fi

  # Read description
  local description=""
  read -p "Description for preset (optional): " description
  if [[ -z "$description" ]]; then
    description="Custom preset saved at $(date +%Y-%m-%d)"
  fi

  # Get current plugins from OpenCode config
  local plugins_json="[]"
  if [[ -f "$OPENCODE_CONFIG" ]]; then
    plugins_json=$(jq -c '.plugin // []' "$OPENCODE_CONFIG")
  fi

  # Create preset JSON
  cat > "$preset_file" << EOF
{
  "name": "$preset_name",
  "description": "$description",
  "plugins": $plugins_json,
  "requires": {}
}
EOF

  log_success "Preset saved: $preset_name"
  log_info "Location: $preset_file"
}

# Restore from backup
restore() {
  local backup_name="${1:-}"

  check_opencode
  ensure_dirs

  if [[ -z "$backup_name" ]]; then
    log_info "Available backups:"
    ls -lt "$BACKUPS_DIR"/*.json 2>/dev/null | head -5
    log_info "Usage: opencode-loadout restore <backup-file> or 'ocl restore <backup-file>'"
    return
  fi

  local backup_file="$BACKUPS_DIR/$backup_name"
  if [[ ! -f "$backup_file" ]]; then
    # Try with .json extension
    backup_file="$BACKUPS_DIR/${backup_name}.json"
    if [[ ! -f "$backup_file" ]]; then
      log_error "Backup not found: $backup_name"
      exit 1
    fi
  fi

  cp "$backup_file" "$OPENCODE_CONFIG"
  log_success "Restored from: $backup_file"
}

# Verify setup
verify() {
  log_info "Verifying OpenCode Presets setup..."

  check_opencode
  ensure_dirs

  log_success "OpenCode version: $(opencode --version)"
  log_info "Presets directory: $PRESETS_DIR"
  log_info "Profiles directory: $PROFILES_DIR"
  log_info "Backups directory: $BACKUPS_DIR"

  local preset_count
  preset_count=$(ls -1 "$PRESETS_DIR"/*.json 2>/dev/null | wc -l)
  log_info "Available presets: $preset_count"

  local profile_count
  profile_count=$(ls -1 "$PROFILES_DIR"/*.json 2>/dev/null | wc -l)
  log_info "Available profiles: $profile_count"

  log_success "Verification complete!"
}

# Check installed plugins
check_plugins() {
  log_info "Checking installed plugins..."

  check_opencode
  ensure_dirs

  local opencode_dir="${OPENCODE_CONFIG_PATH:-$HOME/.config/opencode}"

  if [[ ! -d "$opencode_dir/node_modules" ]]; then
    log_warn "No node_modules directory found in OpenCode config"
    log_info "Install plugins first: bunx oh-my-opencode install"
    return
  fi

  log_info "Installed plugins:"

  local found=false
  for dir in "$opencode_dir/node_modules"/*; do
    if [[ -d "$dir" ]]; then
      local plugin_name
      plugin_name=$(basename "$dir")
      if [[ "$plugin_name" != "." ]] && [[ "$plugin_name" != ".." ]] && [[ "$plugin_name" != "node_modules" ]]; then
        printf "  ${GREEN}✓${NC} %s\n" "$plugin_name"
        found=true
      fi
    fi
  done

  if ! $found; then
    log_warn "No plugins installed"
  fi

  log_info ""
  log_info "Required plugins for presets:"

  for preset_file in "$PRESETS_DIR"/*.json; do
    if [[ -f "$preset_file" ]]; then
      local preset_name
      preset_name=$(basename "$preset_file" .json)
      local plugin_count
      plugin_count=$(jq -r '.plugins | length' "$preset_file" 2>/dev/null)

      if [[ "$plugin_count" -gt 0 ]]; then
        printf "  ${BLUE}%s${NC}: " "$preset_name"

        local missing_count=0
        while IFS= read -r plugin; do
          if [[ -n "$plugin" ]]; then
            if is_plugin_installed "$plugin"; then
              printf "${GREEN}✓${NC} %s " "$plugin"
            else
              printf "${RED}✗${NC} %s " "$plugin"
              ((missing_count++))
            fi
          fi
        done < <(jq -r '.plugins[] // empty' "$preset_file" 2>/dev/null)

        echo ""

        if [[ $missing_count -gt 0 ]]; then
          log_warn "  Missing $missing_count plugin(s)"
        fi
      fi
    fi
  done
}

# Detect current active configurations
detect_active_configs() {
  local active_plugins=()
  local active_configs=()
  
  # Get active plugins from opencode.json
  if [[ -f "$OPENCODE_CONFIG" ]]; then
    active_plugins=$(jq -r ".plugin // []" "$OPENCODE_CONFIG" 2>/dev/null || echo "[]")
  fi
  
  # Detect OMO configuration
  local omo_config=""
  local omo_active="false"
  if echo "$active_plugins" | jq -e "contains(["oh-my-opencode"])" > /dev/null; then
    omo_active="true"
    if [[ -f "$HOME/.config/opencode/oh-my-opencode.json" ]]; then
      omo_config="$HOME/.config/opencode/oh-my-opencode.json"
    fi
  fi
  
  # Detect Orchestra configuration
  local orchestra_config=""
  local orchestra_active="false"
  if echo "$active_plugins" | jq -e "contains(["opencode-orchestrator"])" > /dev/null; then
    orchestra_active="true"
    if [[ -f "$HOME/.config/opencode/orchestrator.json" ]]; then
      orchestra_config="$HOME/.config/opencode/orchestrator.json"
    fi
  fi
  
  # Detect project-specific configs
  local project_omo_config=""
  local project_orchestra_config=""
  if [[ -f ".opencode/oh-my-opencode.json" ]]; then
    project_omo_config=".opencode/oh-my-opencode.json"
  fi
  if [[ -f ".opencode/orchestrator.json" ]]; then
    project_orchestra_config=".opencode/orchestrator.json"
  fi
  
  # Return as JSON for easy parsing
  echo "{
    "plugins": "$active_plugins",
    "omo": {
      "active": "$omo_active",
      "config": "$omo_config",
      "project_config": "$project_omo_config"
    },
    "orchestra": {
      "active": "$orchestra_active",
      "config": "$orchestra_config",
      "project_config": "$project_orchestra_config"
    }
  }"
}

# Show help
help() {
  cat << EOF
 OpenCode Loadout - Configuration Manager for OpenCode

  USAGE:
     opencode-loadout <command> [arguments]
     ocl <command> [arguments]  (abbreviation)

  COMMANDS:
     list                    List available presets
     current                 Show current preset
     switch <preset>         Switch to a preset
     save <name>             Save current configuration as a new preset
     info <preset>           Show preset details
     check-plugins           Check which plugins are installed
     init [preset]           Initialize project with preset
     profile <action>        Manage project profiles
         profile list        List available profiles
         profile use <name>  Use a project profile
     restore [backup]        Restore from backup
     verify                  Verify setup
     help                    Show this help message

  PRESETS:
     core          - Vanilla OpenCode (no plugins)
     omo           - Oh-My-OpenCode with Sisyphus orchestrator
     omo-full      - Oh-My-OpenCode with all agents and features
     orchestra     - Open Orchestra multi-agent system

  EXAMPLES:
     ocl list
     ocl switch omo
     ocl current
     ocl save my-custom-preset
     ocl profile list
     ocl profile use frontend-heavy

 For more info, see: https://github.com/DiegoFdezAb/opencode-loadout
EOF
}

# Main
main() {
  local command="${1:-help}"

  case "$command" in
    list)
      list_presets
      ;;
    current)
      current
      ;;
    switch)
      if [[ $# -lt 2 ]]; then
        log_error "Usage: opencode-loadout switch <preset> or ocl switch <preset>"
        exit 1
      fi
      switch "$2"
      ;;
    save)
      if [[ $# -lt 2 ]]; then
        log_error "Usage: opencode-loadout save <preset-name> or ocl save <preset-name>"
        exit 1
      fi
      save "$2"
      ;;
    info)
      if [[ $# -lt 2 ]]; then
        log_error "Usage: opencode-loadout info <preset> or ocl info <preset>"
        exit 1
      fi
      info "$2"
      ;;
    check-plugins)
      check_plugins
      ;;
    init)
      init "${2:-omo}"
      ;;
    profile)
      if [[ $# -lt 2 ]]; then
        log_error "Usage: opencode-loadout profile <action> or ocl profile <action>"
        exit 1
      fi
      shift
      profile "$@"
      ;;
    restore)
      restore "${2:-}"
      ;;
    verify)
      verify
      ;;
    help|--help|-h)
      help
      ;;
    *)
      log_error "Unknown command: $command"
      help
      exit 1
      ;;
  esac
}

main "$@"
