#!/bin/bash

# OpenCode Presets - Configuration Manager for OpenCode
# Switch between different OpenCode setups easily

set -euo pipefail

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Default paths
CONFIG_FILE="${OPENCODE_PRESETS_CONFIG:-$HOME/.opencode-presets/config.json}"
PRESETS_DIR="${OPENCODE_PRESETS_DIR:-$HOME/.opencode-presets/presets}"
PROFILES_DIR="${OPENCODE_PROFILES_DIR:-$HOME/.opencode-presets/profiles}"
BACKUPS_DIR="${OPENCODE_BACKUPS_DIR:-$HOME/.opencode-presets/backups}"
OPENCODE_CONFIG="${OPENCODE_CONFIG_PATH:-$HOME/.config/opencode/opencode.json}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
  echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
  echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_error() {
  echo -e "${RED}[ERROR]${NC} $1" >&2
}

log_warn() {
  echo -e "${YELLOW}[WARN]${NC} $1"
}

# Check if command exists
command_exists() {
  command -v "$1" &>/dev/null
}

# Ensure required directories exist
ensure_dirs() {
  mkdir -p "$PRESETS_DIR" "$PROFILES_DIR" "$BACKUPS_DIR"
  mkdir -p "$(dirname "$CONFIG_FILE")"
}

# Check if OpenCode is installed
check_opencode() {
  if ! command_exists opencode; then
    log_error "OpenCode is not installed"
    log_info "Install it from: https://opencode.ai"
    exit 1
  fi
}

# Check if a plugin is installed
is_plugin_installed() {
  local plugin_name="$1"
  local opencode_dir="${OPENCODE_CONFIG_PATH:-$HOME/.config/opencode}"

  # Check node_modules
  if [[ -d "$opencode_dir/node_modules/$plugin_name" ]]; then
    return 0
  fi

  return 1
}

# Get installation command for a plugin
get_plugin_install_cmd() {
  local plugin_name="$1"

  case "$plugin_name" in
    "oh-my-opencode")
      echo "bunx oh-my-opencode install"
      ;;
    "opencode-orchestrator")
      echo "bun add opencode-orchestrator"
      ;;
    *)
      echo "npm install $plugin_name"
      ;;
  esac
}

# Backup current config
backup_config() {
  local timestamp
  timestamp=$(date +%Y%m%d_%H%M%S)
  local backup_file="$BACKUPS_DIR/backup-$timestamp.json"

  if [[ -f "$OPENCODE_CONFIG" ]]; then
    cp "$OPENCODE_CONFIG" "$backup_file"
    log_info "Backup saved to: $backup_file"
  fi
}

# List available presets
list_presets() {
  log_info "Available presets:"

  if [[ ! -d "$PRESETS_DIR" ]]; then
    log_warn "No presets directory found"
    return
  fi

  local first=true
  for preset in "$PRESETS_DIR"/*.json; do
    if [[ -f "$preset" ]]; then
      if $first; then
        echo ""
        first=false
      fi

      local name
      name=$(basename "$preset" .json)
      local desc
      desc=$(jq -r '.description // "No description"' "$preset" 2>/dev/null || echo "No description")

      printf "  ${GREEN}%-20s${NC} %s\n" "$name" "$desc"
    fi
  done
}

# Get current preset
get_current_preset() {
  if [[ ! -f "$OPENCODE_CONFIG" ]]; then
    echo "none"
    return
  fi

  local plugins
  plugins=$(jq -r '.plugin // []' "$OPENCODE_CONFIG" 2>/dev/null)

  if [[ "$plugins" == "[]" ]] || [[ -z "$plugins" ]]; then
    echo "core"
  elif echo "$plugins" | grep -q "oh-my-opencode"; then
    echo "omo"
  elif echo "$plugins" | grep -q "opencode-orchestrator"; then
    echo "orchestra"
  else
    echo "custom"
  fi
}

# Show current preset
current() {
  check_opencode
  local current
  current=$(get_current_preset)
  log_success "Current preset: $current"

  if [[ -f "$OPENCODE_CONFIG" ]]; then
    log_info "Active plugins:"
    jq -r '.plugin // []' "$OPENCODE_CONFIG" 2>/dev/null | while read -r plugin; do
      [[ -n "$plugin" ]] && echo "  - $plugin"
    done
  fi
}

# Switch to a preset
switch() {
  local preset_name="$1"

  check_opencode
  ensure_dirs

  # Check if preset exists
  local preset_file="$PRESETS_DIR/${preset_name}.json"
  if [[ ! -f "$preset_file" ]]; then
    log_error "Preset not found: $preset_name"
    log_info "Run 'opencode-presets list' to see available presets"
    exit 1
  fi

  log_info "Switching to preset: $preset_name"

  # Backup current config
  backup_config

  # Check if required plugins are installed
  local missing_plugins=()
  while IFS= read -r plugin; do
    if [[ -n "$plugin" ]] && ! is_plugin_installed "$plugin"; then
      missing_plugins+=("$plugin")
    fi
  done < <(jq -r '.plugins[] // empty' "$preset_file")

  if [[ ${#missing_plugins[@]} -gt 0 ]]; then
    log_error "Plugin(s) non installé(s):"
    for plugin in "${missing_plugins[@]}"; do
      local install_cmd
      install_cmd=$(get_plugin_install_cmd "$plugin")
      echo "  - $plugin"
      log_info "  Installation: $install_cmd"
    done
    exit 1
  fi

  # Read preset config
  local plugins
  plugins=$(jq -r '.plugins // []' "$preset_file")

  # Update OpenCode config
  if [[ -f "$OPENCODE_CONFIG" ]]; then
    # Update plugins array
    if [[ "$plugins" == "[]" ]] || [[ -z "$plugins" ]]; then
      jq 'del(.plugin)' "$OPENCODE_CONFIG" > "${OPENCODE_CONFIG}.tmp"
      mv "${OPENCODE_CONFIG}.tmp" "$OPENCODE_CONFIG"
    else
      jq --argjson plugins "$plugins" '.plugin = $plugins' "$OPENCODE_CONFIG" > "${OPENCODE_CONFIG}.tmp"
      mv "${OPENCODE_CONFIG}.tmp" "$OPENCODE_CONFIG"
    fi
  else
    # Create new config
    echo '{}' > "$OPENCODE_CONFIG"
    jq --argjson plugins "$plugins" '.plugin = $plugins' "$OPENCODE_CONFIG" > "${OPENCODE_CONFIG}.tmp"
    mv "${OPENCODE_CONFIG}.tmp" "$OPENCODE_CONFIG"
  fi

  log_success "Preset applied: $preset_name"
  log_info "Restart OpenCode for changes to take effect"
}

# Initialize project with preset
init() {
  local preset_name="${1:-omo}"

  check_opencode
  ensure_dirs

  if [[ ! -f ".opencode" ]]; then
    mkdir -p .opencode
  fi

  # Copy project-specific config
  local profile_file="$PROFILES_DIR/${preset_name}.json"
  if [[ -f "$profile_file" ]]; then
    cp "$profile_file" .opencode/oh-my-opencode.json
    log_success "Initialized project with preset: $preset_name"
  else
    log_warn "Profile not found: $preset_name"
    log_info "Creating empty config"
    echo '{}' > .opencode/oh-my-opencode.json
  fi
}

# Use project profile
profile() {
  local action="$1"
  shift

  case "$action" in
    list)
      log_info "Available profiles:"
      if [[ -d "$PROFILES_DIR" ]]; then
        for profile in "$PROFILES_DIR"/*.json; do
          if [[ -f "$profile" ]]; then
            local name
            name=$(basename "$profile" .json)
            local desc
            desc=$(jq -r '.description // "No description"' "$profile" 2>/dev/null || echo "No description")
            printf "  ${GREEN}%-20s${NC} %s\n" "$name" "$desc"
          fi
        done
      fi
      ;;
    use)
      local profile_name="$1"
      local profile_file="$PROFILES_DIR/${profile_name}.json"

      if [[ ! -f "$profile_file" ]]; then
        log_error "Profile not found: $profile_name"
        exit 1
      fi

      mkdir -p .opencode
      cp "$profile_file" .opencode/oh-my-opencode.json
      log_success "Using profile: $profile_name"
      ;;
    *)
      log_error "Unknown profile action: $action"
      log_info "Available actions: list, use"
      exit 1
      ;;
  esac
}

# Show preset info
info() {
  local preset_name="$1"
  local preset_file="$PRESETS_DIR/${preset_name}.json"

  if [[ ! -f "$preset_file" ]]; then
    log_error "Preset not found: $preset_name"
    exit 1
  fi

  log_info "Preset: $preset_name"
  jq -r ' "\(.description // "No description")\n\nPlugins: \(.plugins | join(", "))\nRequires: \(.requires | keys | join(", "))"' "$preset_file"
}

# Restore from backup
restore() {
  local backup_name="${1:-}"

  check_opencode
  ensure_dirs

  if [[ -z "$backup_name" ]]; then
    log_info "Available backups:"
    ls -lt "$BACKUPS_DIR"/*.json 2>/dev/null | head -5
    log_info "Usage: opencode-presets restore <backup-file>"
    return
  fi

  local backup_file="$BACKUPS_DIR/$backup_name"
  if [[ ! -f "$backup_file" ]]; then
    # Try with .json extension
    backup_file="$BACKUPS_DIR/${backup_name}.json"
    if [[ ! -f "$backup_file" ]]; then
      log_error "Backup not found: $backup_name"
      exit 1
    fi
  fi

  cp "$backup_file" "$OPENCODE_CONFIG"
  log_success "Restored from: $backup_file"
}

# Verify setup
verify() {
  log_info "Verifying OpenCode Presets setup..."

  check_opencode
  ensure_dirs

  log_success "OpenCode version: $(opencode --version)"
  log_info "Presets directory: $PRESETS_DIR"
  log_info "Profiles directory: $PROFILES_DIR"
  log_info "Backups directory: $BACKUPS_DIR"

  local preset_count
  preset_count=$(ls -1 "$PRESETS_DIR"/*.json 2>/dev/null | wc -l)
  log_info "Available presets: $preset_count"

  local profile_count
  profile_count=$(ls -1 "$PROFILES_DIR"/*.json 2>/dev/null | wc -l)
  log_info "Available profiles: $profile_count"

  log_success "Verification complete!"
}

# Check installed plugins
check_plugins() {
  log_info "Checking installed plugins..."

  check_opencode
  ensure_dirs

  local opencode_dir="${OPENCODE_CONFIG_PATH:-$HOME/.config/opencode}"

  if [[ ! -d "$opencode_dir/node_modules" ]]; then
    log_warn "No node_modules directory found in OpenCode config"
    log_info "Install plugins first: bunx oh-my-opencode install"
    return
  fi

  log_info "Installed plugins:"

  local found=false
  for dir in "$opencode_dir/node_modules"/*; do
    if [[ -d "$dir" ]]; then
      local plugin_name
      plugin_name=$(basename "$dir")
      if [[ "$plugin_name" != "." ]] && [[ "$plugin_name" != ".." ]] && [[ "$plugin_name" != "node_modules" ]]; then
        printf "  ${GREEN}✓${NC} %s\n" "$plugin_name"
        found=true
      fi
    fi
  done

  if ! $found; then
    log_warn "No plugins installed"
  fi

  log_info ""
  log_info "Required plugins for presets:"

  for preset_file in "$PRESETS_DIR"/*.json; do
    if [[ -f "$preset_file" ]]; then
      local preset_name
      preset_name=$(basename "$preset_file" .json)
      local plugin_count
      plugin_count=$(jq -r '.plugins | length' "$preset_file" 2>/dev/null)

      if [[ "$plugin_count" -gt 0 ]]; then
        printf "  ${BLUE}%s${NC}: " "$preset_name"

        local missing_count=0
        while IFS= read -r plugin; do
          if [[ -n "$plugin" ]]; then
            if is_plugin_installed "$plugin"; then
              printf "${GREEN}✓${NC} %s " "$plugin"
            else
              printf "${RED}✗${NC} %s " "$plugin"
              ((missing_count++))
            fi
          fi
        done < <(jq -r '.plugins[] // empty' "$preset_file" 2>/dev/null)

        echo ""

        if [[ $missing_count -gt 0 ]]; then
          log_warn "  Missing $missing_count plugin(s)"
        fi
      fi
    fi
  done
}

# Show help
help() {
  cat << EOF
OpenCode Presets - Configuration Manager for OpenCode

USAGE:
    opencode-presets <command> [arguments]

 COMMANDS:
    list                    List available presets
    current                 Show current preset
    switch <preset>         Switch to a preset
    info <preset>           Show preset details
    check-plugins           Check which plugins are installed
    init [preset]           Initialize project with preset
    profile <action>        Manage project profiles
        profile list        List available profiles
        profile use <name>  Use a project profile
    restore [backup]        Restore from backup
    verify                  Verify setup
    help                    Show this help message

PRESETS:
    core          - Vanilla OpenCode (no plugins)
    omo           - Oh-My-OpenCode with Sisyphus orchestrator
    omo-full      - Oh-My-OpenCode with all agents and features
    orchestra     - Open Orchestra multi-agent system

EXAMPLES:
    opencode-presets list
    opencode-presets switch omo
    opencode-presets current
    opencode-presets profile list
    opencode-presets profile use frontend-heavy

For more info, see: https://github.com/YOUR_USERNAME/opencode-presets
EOF
}

# Main
main() {
  local command="${1:-help}"

  case "$command" in
    list)
      list_presets
      ;;
    current)
      current
      ;;
    switch)
      if [[ $# -lt 2 ]]; then
        log_error "Usage: opencode-presets switch <preset>"
        exit 1
      fi
      switch "$2"
      ;;
    info)
      if [[ $# -lt 2 ]]; then
        log_error "Usage: opencode-presets info <preset>"
        exit 1
      fi
      info "$2"
      ;;
    check-plugins)
      check_plugins
      ;;
    init)
      init "${2:-omo}"
      ;;
    profile)
      if [[ $# -lt 2 ]]; then
        log_error "Usage: opencode-presets profile <action>"
        exit 1
      fi
      profile "$@"
      ;;
    restore)
      restore "${2:-}"
      ;;
    verify)
      verify
      ;;
    help|--help|-h)
      help
      ;;
    *)
      log_error "Unknown command: $command"
      help
      exit 1
      ;;
  esac
}

main "$@"
